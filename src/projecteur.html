<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Projet PRÉSENCE - Flux Des Mots</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000814; }
        
        canvas {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 1;
        }

        #container {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            width: 95vw;
            text-align: center;
            pointer-events: none;
        }

        .mot-affiche {
            display: inline-block;
            color: #ffffff;
            font-family: 'Segoe UI', 'Arial', sans-serif;
            font-weight: 400;
            letter-spacing: 2px;
            white-space: nowrap; 
            opacity: 0;
            filter: blur(10px);
            transform: scale(0.95);
            transition: opacity 1.2s ease, filter 1.2s ease, transform 1.2s ease;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.6);
        }

        .mot-affiche.visible {
            opacity: 1;
            filter: blur(0px);
            transform: scale(1);
        }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>

<div id="container">
    <div id="affichage" class="mot-affiche">Initialisation...</div>
</div>

<script>
    // Fond étoilé lent
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let particles = [];
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener("resize", resize);
    resize();

    const speed = 0.25; 
    class StarParticle {
        constructor() { this.init(); }
        init() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.vx = 0; this.vy = 0;
            this.age = 0;
            this.maxAge = Math.random() * 400 + 200;
            this.color = Math.random() > 0.8 ? "#7dd3fc" : "#f0f9ff";
        }
        update(t) {
            let angle = (Math.sin(this.x * 0.0015 + t * 0.0003) + Math.cos(this.y * 0.0015 + t * 0.0002)) * Math.PI * 2;
            this.vx += Math.cos(angle) * 0.04; this.vy += Math.sin(angle) * 0.04;
            this.vx *= 0.98; this.vy *= 0.98;
            this.x += this.vx * speed; this.y += this.vy * speed;
            this.age++;
            if (this.x < 0 || this.x > canvas.width || this.y < 0 || this.y > canvas.height || this.age > this.maxAge) this.init();
        }
        draw() {
            let opacity = Math.sin((this.age / this.maxAge) * Math.PI) * 0.3;
            ctx.fillStyle = this.color;
            ctx.globalAlpha = opacity;
            ctx.beginPath(); ctx.arc(this.x, this.y, 1.1, 0, Math.PI * 2); ctx.fill();
        }
    }
    for (let i = 0; i < 350; i++) particles.push(new StarParticle());
    function animate(t) {
        ctx.fillStyle = "rgba(0, 8, 20, 0.15)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        particles.forEach(p => { p.update(t); p.draw(); });
        requestAnimationFrame(animate);
    }
    animate(0);

    // Logique d'affichage
    class ProjecteurScene {
        constructor() {
            this.playlist = [{id: 0, texte: "PRÉSENCE"}];
            this.index = 0;
            this.idsConnus = new Set([0]);
            this.el = document.getElementById('affichage');
            this.isAnimating = false;
        }

        async fetchMessages() {
            try {
                const res = await fetch('/get_messages');
                const data = await res.json();
                
                // On parcourt les messages validés
                data.valides.forEach(msg => {
                    if (!this.idsConnus.has(msg.id)) {
                        // On insère le nouveau message juste APRÈS le message actuel
                        // pour qu'il soit le prochain à être diffusé.
                        this.playlist.splice(this.index + 1, 0, msg);
                        this.idsConnus.add(msg.id);
                        console.log("Nouveau message prioritaire :", msg.texte);
                    }
                });
            } catch (e) {}
        }

        ajusterTailleOptimale(texte) {
            const containerWidth = window.innerWidth * 0.9;
            const containerHeight = window.innerHeight * 0.7;
            
            let fontSize = 10;
            this.el.style.fontSize = fontSize + "px";
            
            while (this.el.offsetWidth < containerWidth && this.el.offsetHeight < containerHeight && fontSize < 300) {
                fontSize += 2;
                this.el.style.fontSize = fontSize + "px";
            }
            this.el.style.fontSize = (fontSize * 0.9) + "px";
        }

        async cycle() {
            if (this.playlist.length === 0 || this.isAnimating) return;
            this.isAnimating = true;

            // Sortie
            this.el.classList.remove('visible');
            await new Promise(r => setTimeout(r, 1300));

            // Passage au suivant
            this.index = (this.index + 1) % this.playlist.length;
            const msg = this.playlist[this.index];
            
            this.el.innerText = msg.texte;
            this.ajusterTailleOptimale(msg.texte);

            // Entrée
            this.el.classList.add('visible');
            
            // Affichage 4 secondes
            setTimeout(() => { this.isAnimating = false; }, 4000);
        }
    }

    const maScene = new ProjecteurScene();
    setInterval(() => maScene.fetchMessages(), 3000);
    setInterval(() => maScene.cycle(), 500);
</script>

</body>
</html>